---
title: "Final exam_response"
author: "Zhu Jinzhou"
student number:24080728
date: "2024-12-13"
output: html_document
---

# Originality declaration

I, [**Zhu Jinzhou**], confirm that the work presented in this assessment is my own. Where information has been derived from other sources, I confirm that this has been indicated in the work.


## Initial project scope
The primary objective of this project is to enhance pedestrian safety in Charlotte by implementing targeted interventions such as beacon installations and roadway infrastructure improvements, ultimately aiming to reduce accident rates. To achieve this, the project seeks to identify current high-risk locations and evaluate their validity as priority areas for intervention.

The research is driven by the aim of identifying spatial patterns of accident risk that can guide the City of Charlotte in selecting optimal intersections for future upgrades. To support this goal, the study investigates whether accident occurrences exhibit spatial clustering by conducting a kernel density analysis and calculating spatial autocorrelation metrics, including Moran's I and Local Indicators of Spatial Association (LISA). These analyses aim to assess the statistical significance of spatial similarity in accident distributions.

The null hypothesis assumes that accident occurrences are randomly distributed in space, while the alternative hypothesis posits that they exhibit significant spatial clustering. This project will provide critical insights into spatial accident patterns, offering evidence-based recommendations for infrastructure upgrades to improve pedestrian safety.

# Start your response here
#01 Load all possible packages
```{r}
# load packages
library(tidyverse)
library(sf)
library(sp)
library(spdep)
library(spatstat)
library(spgwr)
library(janitor)
library(here)
library(tmap)
library(broom)
library(performance)
library(car)
```

#02 Import data downloaded online
There are four files in total. injury_crash is about the type and location of the accident, potential point is the location of the safe street construction currently decided to use, tract is the administrative division data of the census, and commuting block is the commuting block situation for traffic.

First check the data fields.
For example:injury_crash file (accident data)
LATITUDE and LONGITUDE: used for spatial analysis to determine the geographic coordinates of the accident site.
CRASH_TYPE: accident type, which helps to identify whether certain types of accidents are more concentrated in certain areas.
DATE_VAL_1: accident date, which can be used to analyze the trend of accidents over time.

potential_point file (proposed traffic point)
LATITUDE and LONGITUDE: also used for spatial analysis to determine the geographic coordinates of the proposed traffic point.
ProjectName and ProjectType: project name and type, which helps to understand the relevance of these points to pedestrian safety projects.

census_tracts file (census tracts)
STATEFP, COUNTYFP, and TRACTCE: These fields identify the state, county, and census tract codes, which can be used to filter data for specific areas.
INTPTLAT and INTPTLON: The coordinates of the center point of the census tract, which can be used for spatial analysis.

commuting_block file (commuting block groups)
STATEFP10, COUNTYFP10, and TRACTCE10: These fields identify the state, county, and census tract codes, which can be used to filter data for specific areas.
geoname: Place names, which help identify specific commuting block groups.

Afterwards, make sure the projected coordinate system of the data used is consistent.
The best selection point for this project is to choose a location with a higher risk of accidents.
```{r}
# load data
injury_crash <- st_read(here::here("01 Fatal_or_Serious_Injury_Crashes/","Fatal_or_Serious_Injury_Crashes.shp"))

potential_point <- st_read(here::here("02 Safe_Streets_For_All_Grant_Projects/","Safe_Streets_For_All_Grant_Projects.shp"))

tract <- st_read(here::here("04 tl_2024_37_tract/","tl_2024_37_tract.shp"))

commuting_block <- st_read(here::here("05 Census_Commuting_Block_Groups/","Census_Commuting_Block_Groups.shp"))
```

```{r}
# check data types
injury_crash %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

potential_point %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

tract %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

commuting_block %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

# ensure using a same crs
st_crs(injury_crash)
st_crs(potential_point)
st_crs(tract)
st_crs(commuting_block)

tract = tract %>% 
  st_transform(.,st_crs(injury_crash))
```

#03 Data screening and rapid visualization
The cityâ€™s administrative divisions were taken from census data, and since the research was focused on commuting and transportation, the visualization I ultimately chose used commuter blocks to quickly visualize where all the accidents occurred.
```{r}
## Wrangling data
# Filter data only to Charlotte City
charlotte_tracts <- tract %>%
  filter(STATEFP == "37" & COUNTYFP == "119")

# quick map
tmap_mode("plot")
tm_shape(commuting_block) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(injury_crash) +
  tm_dots(col = "blue",size=0.2)+ 
  tm_layout(main.title = "Location of the Accident",
		main.title.position = "center")

tm_shape(commuting_block) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(potential_point) +
  tm_dots(col = "blue",size=0.5) + 
  tm_layout(title = "Proposed Safe Streets for All Project")
```
The first picture: There are 789 accidents in total, with more accidents in the central city and fewer in the suburbs; there are no accidents in the north and southeast, and it seems that the space is concentrated in the urban area. The second picture: There are 22 planned safe streets in total, which are relatively scattered.

#04 Screening for project-related injuries
I chose the last five years of data because incidents that may be too old are caused by other things, such as road disrepair that has been repaired, outdated transportation and traffic conditions, etc.
Then I filtered the accidents directly and indirectly related to pedestrian safety in CRASH_TYPE: 
1. "Pedestrian": Accidents directly involving pedestrians
2. "Pedalcyclist": Involving cyclists, who are not pedestrians but are also vulnerable road users.
Other types of accidents may indirectly affect pedestrian safety, such as:
1. "Left turn, same roadway" and "Left turn, different roadways": Conflicts with pedestrians may occur when turning left, especially at intersections.
2. "Right turn, same roadway" and "Right turn, different roadways": Conflicts with pedestrians may also occur when turning right.
3. "Crossed centerline/median": Accidents crossing the centerline or median may involve pedestrians crossing the road.
4. "Fixed object"": Collisions with fixed objects (such as trees, lamp posts, etc.) may occur when pedestrians are crossing the road or walking on the side of the road.
5. "Ran off road right", "Ran off road left" and "Ran off road straight ahead": Vehicles running off the road may affect pedestrians, especially when pedestrians are walking on the roadside or waiting for public transportation. 
The first two are directly related to pedestrians, and the others are indirectly related.
Then, visualize the filtered data.
```{r}
## filter accident event
unique(injury_crash$CRASH_TYPE) # check crash type

# Screening pedestrian accidents
Pedestrian_crash = injury_crash %>% 
  filter(DATE_VAL_Y %in% c(2023,2022,2021,2020,2019) ) %>% 
  filter(CRASH_TYPE == "Pedestrian")

# quick map
tmap_mode("plot")
tm_shape(commuting_block) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(Pedestrian_crash) +
  tm_dots(col = "blue",size=0.2)+ 
  tm_layout(main.title = "Location of the Pedestrian Accident",
		main.title.position = "center")
```
#05 Kernel Density Analysis
The original data is in m units, so I can directly perform kernel density analysis. So I created an observation window, then created sp and spp objects, and finally drew a kernel density graph.
```{r}
#Create observation window
window <- as.owin(commuting_block)

#create a sp object
Pedestrian_crash_sp <- Pedestrian_crash %>%
  as(., 'Spatial')

#create a ppp object
Pedestrian_crash_sp.ppp <- ppp(x=Pedestrian_crash_sp@coords[,1],
                          y=Pedestrian_crash_sp@coords[,2],
                          window=window)

# kernel density analysis,
Pedestrian_crash_sp.ppp %>%
  density(., sigma=2000) %>%
  plot()
```
The brightest areas (yellow to red) in the figure represent the areas with the highest concentration of pedestrian incidents. These areas are likely to be high-incidence areas for pedestrian accidents, which means that pedestrian accidents occur frequently in these commuting areas. Since they are in the city center, it may be because everyone works in the city center and rushes to work.

Dark blue areas indicate fewer pedestrian incidents. Residents in these areas are less likely to face accidents, which may be due to smoother traffic, good infrastructure, low passenger flow, etc.

From the distribution in the figure, it can be seen that pedestrian accidents tend to concentrate in specific commuting areas. This trend is mainly in the city center, but this trend is still relatively scattered and independent among various commuting areas. Next, it is necessary to analyze this spatial aggregation to test whether it is significant.


```{r}
## Spatial Autocorrelation
points_sf_joined <- commuting_block%>%
  mutate(n = lengths(st_intersects(., Pedestrian_crash)))%>%
  janitor::clean_names()%>%
  mutate(area=st_area(.))%>%
  mutate(density=n/area)

# quick map
tm_shape(points_sf_joined) +
    tm_polygons("density",
        style="jenks",
        palette="PuOr",
        title="Accident density")
```

Now I need to find the centroid, so I made the spatial weights matrix.
```{r}
coordsW <- points_sf_joined%>%
  st_centroid()%>%
  st_geometry()
plot(coordsW,axes=TRUE)

# find neighbours
community_nb <- points_sf_joined %>%
  poly2nb(., queen=T)
 summary(community_nb) 

#plot them
plot(community_nb, st_geometry(coordsW), col="red")
#add a map underneath
plot(points_sf_joined$geometry, add=T)
```

Now I need to calculate the global Moran's I.
```{r}
# make weight matrix
community_nb.lw <- community_nb %>%
  nb2mat(., style="W")
sum(community_nb.lw)

# make weight list for Moran's I
community_nb.lw <- community_nb %>%
  nb2listw(., style="W")

# calculate global moran'1
I_LWard_Global_Density <- points_sf_joined %>%
  pull(density) %>%
  as.vector()%>%
  moran.test(., community_nb.lw)

I_LWard_Global_Density
```

```{r}
# calculate local moran
I_LWard_Local_density <- points_sf_joined %>%
  pull(density) %>%
  as.vector()%>%
  localmoran(., community_nb.lw)%>%
  as_tibble()
I_LWard_Local_density

# plot local moran and potential safe street
points_sf_joined <- points_sf_joined %>%
  mutate(density_I =as.numeric(I_LWard_Local_density$Ii))%>%
  mutate(density_Iz =as.numeric(I_LWard_Local_density$Z.Ii))

summary(points_sf_joined$density_Iz)
 
breaks <-c(-10,-2.58,-1.96,-1.65,1.65,1.96,2.58,10)

library(RColorBrewer)
MoranColours<- rev(brewer.pal(8, "RdGy"))

tm_shape(points_sf_joined) +
    tm_polygons("density_Iz",
        style="fixed",
        breaks=breaks,
        palette=MoranColours,
        midpoint=NA,
        title="Local Moran's I, Acciendents",
        position = "bottomright") +
    tm_shape(potential_point) +
    tm_dots(col = "blue",size=0.5)
```


