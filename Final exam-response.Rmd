---
title: "Final exam_response"
author: "Zhu Jinzhou"
student number:24080728
date: "2024-12-13"
output: html_document
---

# Originality declaration

I, [**Zhu Jinzhou**], confirm that the work presented in this assessment is my own. Where information has been derived from other sources, I confirm that this has been indicated in the work.

# Start your response here

```{r}
# load packages
library(tidyverse)
library(sf)
library(sp)
library(spdep)
library(spatstat)
library(spgwr)
library(janitor)
library(here)
library(tmap)
library(broom)
library(performance)
library(car)
```

Importing Data
```{r}
# load data
injury_crash <- st_read(here::here("01 Fatal_or_Serious_Injury_Crashes/","Fatal_or_Serious_Injury_Crashes.shp"))

potential_point <- st_read(here::here("02 Safe_Streets_For_All_Grant_Projects/","Safe_Streets_For_All_Grant_Projects.shp"))

tract <- st_read(here::here("04 tl_2024_37_tract/","tl_2024_37_tract.shp"))

commuting_block <- st_read(here::here("05 Census_Commuting_Block_Groups/","Census_Commuting_Block_Groups.shp"))
```

Check the data field format and ensure that they are in the same coordinate system
```{r}
# check data types
injury_crash %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

potential_point %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

tract %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

commuting_block %>% 
    st_drop_geometry%>% 
    summarise_all(class) %>%
    pivot_longer(everything(),   
                 names_to="All_variables", 
                 values_to="Variable_class")

# ensure using a same crs
st_crs(injury_crash)
st_crs(potential_point)
st_crs(tract)
st_crs(commuting_block)

tract = tract %>% 
  st_transform(.,st_crs(injury_crash))
```

```{r}
## Wrangling data
# Filter data only to Charlotte City
charlotte_tracts <- tract %>%
  filter(STATEFP == "37" & COUNTYFP == "119")

# quick map
tmap_mode("plot")
tm_shape(commuting_block) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(injury_crash) +
  tm_dots(col = "blue",size=0.2)+ 
  tm_layout(main.title = "Location of the Accident",
		main.title.position = "center")

tm_shape(commuting_block) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(potential_point) +
  tm_dots(col = "blue",size=0.5) + 
  tm_layout(title = "Proposed Safe Streets for All Project")
```

```{r}
## filter accident event
unique(injury_crash$CRASH_TYPE) # check crash type

# Screening pedestrian accidents
Pedestrian_crash = injury_crash %>% 
  filter(DATE_VAL_Y %in% c(2023,2022,2021,2020,2019) ) %>% 
  filter(CRASH_TYPE == "Pedestrian")

# quick map
tmap_mode("plot")
tm_shape(commuting_block) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(Pedestrian_crash) +
  tm_dots(col = "blue",size=0.2)+ 
  tm_layout(main.title = "Location of the Pedestrian Accident",
		main.title.position = "center")
```

```{r}
#Create observation window
window <- as.owin(commuting_block)

#create a sp object
Pedestrian_crash_sp <- Pedestrian_crash %>%
  as(., 'Spatial')

#create a ppp object
Pedestrian_crash_sp.ppp <- ppp(x=Pedestrian_crash_sp@coords[,1],
                          y=Pedestrian_crash_sp@coords[,2],
                          window=window)

# kernel density analysis,
Pedestrian_crash_sp.ppp %>%
  density(., sigma=2000) %>%
  plot()
```

```{r}
## Spatial Autocorrelation
points_sf_joined <- commuting_block%>%
  mutate(n = lengths(st_intersects(., Pedestrian_crash)))%>%
  janitor::clean_names()%>%
  mutate(area=st_area(.))%>%
  mutate(density=n/area)

# quick map
tm_shape(points_sf_joined) +
    tm_polygons("density",
        style="jenks",
        palette="PuOr",
        title="Accident density")
```

Now I need to find the centroid, so I made the spatial weights matrix.
```{r}
coordsW <- points_sf_joined%>%
  st_centroid()%>%
  st_geometry()
plot(coordsW,axes=TRUE)

# find neighbours
community_nb <- points_sf_joined %>%
  poly2nb(., queen=T)
 summary(community_nb) 

#plot them
plot(community_nb, st_geometry(coordsW), col="red")
#add a map underneath
plot(points_sf_joined$geometry, add=T)
```

Now I need to calculate the global Moran's I.
```{r}
# make weight matrix
community_nb.lw <- community_nb %>%
  nb2mat(., style="W")
sum(community_nb.lw)

# make weight list for Moran's I
community_nb.lw <- community_nb %>%
  nb2listw(., style="W")

# calculate global moran'1
I_LWard_Global_Density <- points_sf_joined %>%
  pull(density) %>%
  as.vector()%>%
  moran.test(., community_nb.lw)

I_LWard_Global_Density
```

## Initial project scope
